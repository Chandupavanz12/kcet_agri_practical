import{b as W,c as _,u as G,r as i,a as $,j as s}from"./index-pB9rXeLh.js";function J(){const{testId:x}=W(),f=_(),{token:j}=G(),[Q,w]=i.useState(!0),[T,E]=i.useState(""),[b,L]=i.useState(null),[o,q]=i.useState([]),[l,P]=i.useState(0),[g,S]=i.useState({}),[N,A]=i.useState(new Set),[c,C]=i.useState(!1),[F]=i.useState(Date.now()),[u,M]=i.useState(0),v=i.useRef(!1),a=o[l];i.useEffect(()=>{let t=!0;return(async()=>{var n,r;try{w(!0),console.log("[MockTest] Loading test with ID:",x);const d=new Promise((R,k)=>setTimeout(()=>k(new Error("Test load timeout")),12e3)),m=await Promise.race([$(`/api/student/tests/${x}/start`,{token:j}),d]);if(!t)return;console.log("[MockTest] Test data received:",m),L(m.test),q(m.questions||[]);const I=m.test.questionCount*m.test.perQuestionSeconds;M(I),console.log("[MockTest] Questions loaded:",(n=m.questions)==null?void 0:n.length),console.log("[MockTest] Initial timer set to:",I,"seconds"),(r=m.questions)==null||r.forEach((R,k)=>{console.log(`[MockTest] Question ${k+1} image URL:`,R.imageUrl)})}catch(d){if(!t)return;console.error("[MockTest] Error loading test:",d),E((d==null?void 0:d.message)||"Failed to load test")}finally{if(!t)return;w(!1)}})(),()=>{t=!1}},[x,j]),i.useEffect(()=>{if(!b||o.length===0){console.log("[MockTest] Timer - test not loaded yet, skipping");return}if(console.log("[MockTest] Timer effect - secondsLeft:",u),u<=0){console.log("[MockTest] Timer expired - submitting test"),y();return}const t=setTimeout(()=>M(u-1),1e3);return()=>clearTimeout(t)},[u,b,o.length]);const U=i.useCallback(t=>{if(c)return;const n=a.id;S(r=>({...r,[n]:t}))},[a==null?void 0:a.id,c]),D=i.useCallback(()=>{const t=a.id;A(n=>{const r=new Set(n);return r.has(t)?r.delete(t):r.add(t),r})},[a==null?void 0:a.id]),h=i.useCallback(t=>{t>=0&&t<o.length&&P(t)},[o.length]),p=i.useCallback(()=>{h(l+1)},[l,h]),B=i.useCallback(()=>{h(l-1)},[l,h]),z=i.useCallback(()=>{const t=a.id;S(n=>{const r={...n};return delete r[t],r}),p()},[a==null?void 0:a.id,p]),y=async()=>{if(!(c||v.current)){C(!0),v.current=!0;try{const t=Math.round((Date.now()-F)/1e3),n=o.map(r=>({questionId:r.id,selected:g[r.id]??null}));await $(`/api/student/tests/${x}/submit`,{token:j,method:"POST",body:{responses:n,timeTakenSec:t}}),f(`/student/mock-test/result?testId=${x}`,{replace:!0})}catch(t){alert((t==null?void 0:t.message)||"Failed to submit test"),C(!1),v.current=!1}}},O=t=>{const n=Math.floor(t/60),r=t%60;return`${n}:${r.toString().padStart(2,"0")}`};return Q?s.jsx("div",{className:"flex min-h-screen items-center justify-center",children:s.jsx("div",{className:"text-lg",children:"Loading test..."})}):T?s.jsx("div",{className:"flex min-h-screen items-center justify-center px-4",children:s.jsx("div",{className:"card max-w-lg w-full",children:s.jsxs("div",{className:"card-body space-y-3",children:[s.jsx("div",{className:"text-lg font-semibold",children:"Unable to load test"}),s.jsx("div",{className:"text-sm text-slate-600",children:T}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{className:"btn-primary",onClick:()=>window.location.reload(),children:"Retry"}),s.jsx("button",{className:"btn-ghost",onClick:()=>f("/student/dashboard"),children:"Back"})]})]})})}):b?o.length===0?s.jsx("div",{className:"flex min-h-screen items-center justify-center px-4",children:s.jsx("div",{className:"card max-w-lg w-full",children:s.jsxs("div",{className:"card-body space-y-3",children:[s.jsx("div",{className:"text-lg font-semibold",children:"No Questions Available"}),s.jsx("div",{className:"text-sm text-slate-600",children:"This test doesn't have any questions yet. Please contact your administrator."}),s.jsx("button",{className:"btn-ghost",onClick:()=>f("/student/dashboard"),children:"Back to Dashboard"})]})})}):a?s.jsxs("div",{className:"min-h-screen bg-slate-50",children:[s.jsx("header",{className:"sticky top-0 z-10 border-b bg-white px-4 py-3 shadow-sm",children:s.jsxs("div",{className:"mx-auto max-w-6xl flex items-center justify-between",children:[s.jsx("div",{className:"text-sm font-medium",children:b.title}),s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsxs("div",{className:"text-sm text-slate-600",children:["Question ",l+1," of ",o.length]}),s.jsx("div",{className:`text-sm font-semibold ${u<=30?"text-red-600":"text-slate-700"}`,children:O(u)})]})]})}),s.jsx("div",{className:"mx-auto max-w-6xl px-4 py-6",children:s.jsxs("div",{className:"grid gap-6 lg:grid-cols-4",children:[s.jsx("div",{className:"lg:col-span-3",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[s.jsxs("h3",{className:"text-lg font-semibold",children:["Q",l+1,". ",a.questionText]}),s.jsx("button",{onClick:D,className:`px-3 py-1 text-sm rounded-md ${N.has(a.id)?"bg-orange-100 text-orange-700 border border-orange-300":"bg-gray-100 text-gray-700 border border-gray-300"}`,children:N.has(a.id)?"✓ Marked for Review":"Mark for Review"})]}),s.jsx("div",{className:"mb-6 flex justify-center",children:s.jsx("img",{src:a.imageUrl.startsWith("http")?a.imageUrl:`http://localhost:5001${a.imageUrl}`,alt:`Question ${l+1}`,className:"h-64 w-auto rounded-lg border object-contain",onError:t=>{console.log("[MockTest] Image failed to load:",t.target.src),t.target.src="https://via.placeholder.com/400x300?text=Image+Not+Available",t.target.onerror=null},onLoad:()=>{console.log("[MockTest] Image loaded successfully:",e.target.src)}})}),s.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:a.options.map((t,n)=>s.jsx("button",{onClick:()=>U(n),disabled:c,className:`p-4 text-left border-2 rounded-lg transition-colors ${g[a.id]===n?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,children:s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:`w-6 h-6 rounded-full border-2 flex items-center justify-center ${g[a.id]===n?"border-blue-500 bg-blue-500":"border-gray-300"}`,children:g[a.id]===n&&s.jsx("div",{className:"w-2 h-2 bg-white rounded-full"})}),s.jsxs("span",{className:"font-medium",children:[String.fromCharCode(65+n),"."]}),s.jsx("span",{children:t})]})},n))}),s.jsxs("div",{className:"mt-6 flex flex-wrap gap-2 justify-between",children:[s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{onClick:B,disabled:l===0,className:"btn-ghost",children:"← Previous"}),s.jsx("button",{onClick:z,disabled:c,className:"btn-ghost",children:"Skip"})]}),s.jsx("div",{className:"flex gap-2",children:l<o.length-1?s.jsx("button",{onClick:p,disabled:c,className:"btn-primary",children:"Next →"}):s.jsx("button",{onClick:y,disabled:c,className:"btn-primary",children:"Submit Test"})})]})]})})}),s.jsx("div",{className:"lg:col-span-1",children:s.jsx("div",{className:"card",children:s.jsxs("div",{className:"card-body",children:[s.jsx("h3",{className:"font-semibold mb-3",children:"Question Palette"}),s.jsx("div",{className:"grid grid-cols-5 gap-2",children:o.map((t,n)=>{const r=g[t.id]!==void 0,d=N.has(t.id),m=n===l;return s.jsx("button",{onClick:()=>h(n),className:`w-10 h-10 rounded text-sm font-medium transition-colors ${m?"bg-blue-500 text-white":r?d?"bg-orange-500 text-white":"bg-green-500 text-white":d?"bg-orange-100 text-orange-700 border border-orange-300":"bg-gray-100 text-gray-700 border border-gray-300"}`,children:n+1},t.id)})}),s.jsxs("div",{className:"mt-4 space-y-2 text-sm",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-4 h-4 bg-green-500 rounded"}),s.jsx("span",{children:"Answered"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-4 h-4 bg-orange-500 rounded"}),s.jsx("span",{children:"Answered & Marked"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-4 h-4 bg-orange-100 border border-orange-300 rounded"}),s.jsx("span",{children:"Marked for Review"})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-4 h-4 bg-gray-100 border border-gray-300 rounded"}),s.jsx("span",{children:"Not Answered"})]})]}),s.jsx("div",{className:"mt-4 pt-4 border-t",children:s.jsx("button",{onClick:y,disabled:c,className:"btn-primary w-full",children:c?"Submitting...":"Submit Test"})})]})})})]})})]}):s.jsx("div",{className:"flex min-h-screen items-center justify-center",children:s.jsx("div",{className:"text-lg",children:"Question not found"})}):s.jsx("div",{className:"flex min-h-screen items-center justify-center",children:s.jsx("div",{className:"text-lg",children:"Test not found"})})}export{J as default};
